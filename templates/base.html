<!doctype html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>{{ title or "Enterprise System" }}</title>

    <!-- SEO -->
    <meta name="description" content="Enterprise Management System – تقارير – مواقع – صلاحيات – مستخدمين">
    <meta name="theme-color" content="#0d6efd">

    <!-- Bootstrap RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <style>

        /* ========================================================= */
        /*  0) LOADER                                                */
        /* ========================================================= */
        #loader {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            transition: opacity 0.5s ease;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #ccc;
            border-top-color: #0d6efd;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================================= */
        /* 1) THEME SYSTEM                                           */
        /* ========================================================= */

        :root {
            --bg: #f5f7fb;
            --card-bg: #fff;
            --text: #222;
            --sidebar-bg1: #0d6efd;
            --sidebar-bg2: #0a58ca;
            --sidebar-hover: rgba(255,255,255,0.15);
            --link: #fff;
            --border: #ddd;
            --ripple-color: rgba(255,255,255,0.4);
        }

        [data-theme="dark"] {
            --bg: #181a1e;
            --card-bg: #24272b;
            --text: #f1f1f1;
            --sidebar-bg1: #0b5ed7;
            --sidebar-bg2: #0a4fb5;
            --sidebar-hover: rgba(0,0,0,0.2);
            --link: #fff;
            --border: #555;
            --ripple-color: rgba(255,255,255,0.2);
        }

        body {
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            animation: fadeIn 0.5s ease;
        }

        /* ========================================================= */
        /* 2) SIDEBAR WITH GRADIENT                                  */
        /* ========================================================= */

        .sidebar {
            width: 240px;
            min-height: 100vh;
            background: linear-gradient(175deg, var(--sidebar-bg1), var(--sidebar-bg2));
            color: var(--link);
            position: fixed;
            top: 0;
            right: 0;
            z-index: 2000;
            animation: slideIn 0.4s ease;
        }

        .sidebar a {
            padding: 12px 16px;
            display: block;
            border-radius: 6px;
            margin-bottom: 6px;
            color: var(--link);
            transition: background 0.25s, transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .sidebar a:hover {
            background: var(--sidebar-hover);
            transform: translateX(-6px);
        }

        /* Ripple effect */
        .sidebar a::after {
            content: "";
            position: absolute;
            inset: 0;
            background: var(--ripple-color);
            opacity: 0;
            transition: opacity 0.25s;
        }

        .sidebar a:active::after {
            opacity: 0.4;
        }

        /* Mobile sidebar */
        @media(max-width: 992px) {
            .sidebar {
                transform: translateX(260px);
            }
            .sidebar.show {
                transform: translateX(0);
            }
        }

        /* ========================================================= */
        /* 3) CONTENT                                                 */
        /* ========================================================= */

        .content {
            margin-right: 240px;
            padding: 20px;
            transition: margin-right 0.3s;
            animation: fadeIn 0.7s ease;
        }

        @media(max-width: 992px) {
            .content { margin-right: 0 !important; }
        }

        .toggle-btn {
            display: none;
        }

        @media(max-width: 992px) {
            .toggle-btn { display: inline-block; }
        }

        /* ========================================================= */
        /* 4) CARDS ANIMATION (Dashboard)                             */
        /* ========================================================= */

        .card-animate {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.25s, box-shadow 0.25s;
            animation: fadeLift 0.6s ease;
        }

        .card-animate:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        @keyframes fadeLift {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ========================================================= */
        /* 5) TABLE ANIMATION                                        */
        /* ========================================================= */

        table {
            animation: tableFade 0.6s ease;
        }

        @keyframes tableFade {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ========================================================= */
        /* 6) ANIMATIONS / GENERAL                                   */
        /* ========================================================= */

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        @keyframes slideIn {
            from { transform: translateX(260px); }
            to   { transform: translateX(0); }
        }

    </style>
</head>

<body>

<!-- Loader -->
<div id="loader"><div class="spinner"></div></div>

<div class="d-flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar p-3">
        <div class="text-center py-3 border-bottom">
            <img src="/static/logo.png" style="max-width:140px;">
        </div>

        <div class="mt-3">
            <a href="/"><i class="fa fa-home ms-2"></i> لوحة التحكم</a>
            <a href="/reports"><i class="fa fa-file-lines ms-2"></i> التقارير</a>
    
            <a href="/sites"><i class="fa fa-map-location-dot ms-2"></i> المواقع</a>
            <a href="/contractors"><i class="fa fa-building ms-2"></i> المقاولون</a>
            <a href="/users"><i class="fa fa-users ms-2"></i> المستخدمون</a>
            <a href="/admin/user_permissions"><i class="fa fa-user-shield ms-2"></i> صلاحيات المستخدمين</a>
            <a class="text-danger mt-4" href="/logout"><i class="fa fa-right-from-bracket ms-2"></i> خروج</a>
        </div>
    </aside>

    <!-- Content -->
    <div class="content w-100">

        <!-- Topbar -->
        <div class="topbar d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0">{{ title or "لوحة التحكم" }}</h4>
                <small class="text-muted">مرحبًا، {{ session.get("fullname") }}</small>
            </div>

            <div>
                <!-- Theme button -->
                <i class="fa-solid fa-circle-half-stroke theme-toggle me-3" onclick="toggleTheme()"></i>

                <!-- Mobile sidebar -->
                <button class="btn btn-outline-primary toggle-btn" onclick="toggleSidebar()">
                    <i class="fa fa-bars"></i>
                </button>
            </div>
        </div>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for m in messages %}
                <div class="alert alert-info">{{ m }}</div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Page Content -->
        {% block content %}{% endblock %}

        <footer class="mt-5 text-center small text-muted">
            © {{ current_year }} Enterprise System — جميع الحقوق محفوظة
        </footer>

    </div>
</div>

<!-- Scripts -->
<script>

    /* Loader Hide */
    window.onload = function(){
        setTimeout(() => {
            document.getElementById("loader").style.opacity = "0";
            setTimeout(() => document.getElementById("loader").style.display = "none", 400);
        }, 300);
    }

    /* Sidebar Toggle */
    function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("show");
    }

    /* Theme Switching */
    function applyStoredTheme() {
        let theme = localStorage.getItem("theme");
        if (!theme) {
            theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        }
        document.documentElement.setAttribute("data-theme", theme);
    }

    function toggleTheme() {
        let current = document.documentElement.getAttribute("data-theme");
        let newTheme = current === "light" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
    }

    applyStoredTheme();

    

</script>

<!-- Toast for notifications -->


<script>
/* Polling notifications every 8 seconds (تعديل حسب الحاجة) */
let notifPollInterval = 8000;
let lastNotifs = {}; // map id->is_read to detect new

async function fetchNotifications() {
  try {
    const res = await fetch('/api/notifications/list', { credentials: 'same-origin' });
    if (!res.ok) return;
    const list = await res.json();

    // update panel list
    const panel = document.getElementById('notif-list');
    const countBadge = document.getElementById('notif-count');
    panel.innerHTML = '';
    let unread = 0;

    list.forEach(n => {
      const li = document.createElement('li');
      li.className = 'notif-item d-flex justify-content-between align-items-start';
      li.innerHTML = `<div>
                        <div class="fw-bold">${escapeHtml(n.title)}</div>
                        <div class="small text-muted">${escapeHtml(n.body || '')}</div>
                        <div class="small text-muted">${n.created_at}</div>
                      </div>
                      <div class="notif-actions ms-2">
                        ${n.is_read ? '' : '<button class="btn btn-sm btn-outline-primary mark-read">Mark</button>'}
                      </div>`;
      li.dataset.id = n.notification_id;
      panel.appendChild(li);

      if (!n.is_read) unread++;

      // detect new unread (toast)
      if (!lastNotifs[n.notification_id] && !n.is_read) {
        showToast(n.title, n.body, n.url);
      }
      lastNotifs[n.notification_id] = n.is_read;
    });

    if (unread > 0) {
      countBadge && (countBadge.innerText = unread);
      countBadge && countBadge.classList.remove('d-none');
    } else {
      if (countBadge) {
        countBadge.classList.add('d-none');
        countBadge.innerText = '';
      }
    }

    // attach mark-read handlers
    document.querySelectorAll('.mark-read').forEach(btn=>{
      btn.onclick = async function(e){
        const nid = this.closest('.notif-item').dataset.id;
        await fetch('/api/notifications/mark_read', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({notification_id: nid})
        });
        fetchNotifications(); // refresh
      };
    });

  } catch (e) {
    console.error('notif fetch error', e);
  }
}

function escapeHtml(s){
  if(!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* small toast helper */
function showToast(title, body, url){
  try{
    const txt = document.getElementById('flash-message-body');
    txt.innerText = `${title} - ${body || ''}`;
    const tEl = document.getElementById('flashToast');
    new bootstrap.Toast(tEl).show();
    // optionally, you can flash a browser notification (Notification API) after permission
  }catch(e){ console.warn(e); }
}

document.addEventListener('DOMContentLoaded', function(){
  fetchNotifications();
  setInterval(fetchNotifications, notifPollInterval);
});
</script>


</body>
</html>
